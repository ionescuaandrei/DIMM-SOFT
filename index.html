<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bluetooth Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #messageContainer {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
        }
        #messageInput {
            width: 70%;
            padding: 10px;
            margin-right: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
        }
        .sent {
            background-color: #e3f2fd;
            text-align: right;
        }
        .received {
            background-color: #f5f5f5;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Bluetooth Chat</h1>
    <div id="status"></div>
    <button id="connectBtn">Connect to Device</button>
    <div id="messageContainer"></div>
    <div>
        <input type="text" id="messageInput" placeholder="Type your message..." disabled>
        <button id="sendBtn" disabled>Send</button>
    </div>

    <script>
        let bluetoothDevice;
        let characteristicCache;
        const statusDiv = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messageContainer = document.getElementById('messageContainer');

        // Check if Web Bluetooth is supported
        if (!navigator.bluetooth) {
            updateStatus('Web Bluetooth is not supported in your browser. Try using Chrome or Edge.', true);
            connectBtn.disabled = true;
        }

        connectBtn.addEventListener('click', connect);
        sendBtn.addEventListener('click', sendMessage);

        async function connect() {
            try {
                updateStatus('Requesting Bluetooth device...', false);

                // Request device with multiple service options
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    // Accept all devices that support any of these services
                    optionalServices: [
                        '0000FFE0-0000-1000-8000-00805F9B34FB', // Generic chat service
                        '0000FFE1-0000-1000-8000-00805F9B34FB', // Generic chat characteristic
                        '6E400001-B5A3-F393-E0A9-E50E24DCCA9E', // Nordic UART
                        '0000181A-0000-1000-8000-00805F9B34FB', // Environmental Sensing
                    ],
                    // Accept any Bluetooth LE device
                    acceptAllDevices: true
                });

                updateStatus('Connecting to device...', false);
                const server = await bluetoothDevice.gatt.connect();

                // Try to find a supported service
                let service;
                try {
                    service = await server.getPrimaryService('0000FFE0-0000-1000-8000-00805F9B34FB');
                } catch (e) {
                    try {
                        service = await server.getPrimaryService('6E400001-B5A3-F393-E0A9-E50E24DCCA9E');
                    } catch (e2) {
                        throw new Error('No compatible service found');
                    }
                }

                // Try to find a characteristic
                try {
                    characteristicCache = await service.getCharacteristic('0000FFE1-0000-1000-8000-00805F9B34FB');
                } catch (e) {
                    try {
                        characteristicCache = await service.getCharacteristic('6E400003-B5A3-F393-E0A9-E50E24DCCA9E');
                    } catch (e2) {
                        throw new Error('No compatible characteristic found');
                    }
                }

                // Enable notifications
                await characteristicCache.startNotifications();
                characteristicCache.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);

                // Update UI
                updateStatus('Connected to ' + bluetoothDevice.name, false);
                connectBtn.textContent = 'Connected';
                connectBtn.disabled = true;
                messageInput.disabled = false;
                sendBtn.disabled = false;

                // Handle disconnection
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error: ' + error.message, true);
                onDisconnected();
            }
        }

        function updateStatus(message, isError) {
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'error' : '';
        }

        function onDisconnected() {
            updateStatus('Device disconnected', true);
            connectBtn.textContent = 'Connect to Device';
            connectBtn.disabled = false;
            messageInput.disabled = true;
            sendBtn.disabled = true;
            characteristicCache = null;
        }

        async function sendMessage() {
            if (!characteristicCache) {
                updateStatus('Not connected to any device', true);
                return;
            }

            const message = messageInput.value.trim();
            if (message === '') {
                return;
            }

            try {
                const encoder = new TextEncoder();
                await characteristicCache.writeValue(encoder.encode(message));
                
                addMessageToContainer(message, true);
                messageInput.value = '';
            } catch (error) {
                console.error('Error:', error);
                updateStatus('Failed to send message: ' + error.message, true);
            }
        }

        function handleCharacteristicValueChanged(event) {
            const decoder = new TextDecoder();
            const message = decoder.decode(event.target.value);
            addMessageToContainer(message, false);
        }

        function addMessageToContainer(message, sent) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(sent ? 'sent' : 'received');
            messageElement.textContent = message;
            messageContainer.appendChild(messageElement);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        messageInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>