<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/nav/nav.css">
    <title>Chat List</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e1e1e; 
            color: #fff;
        }
        .container {
            width: 90%;
            max-width: 400px;
        }
        .section {
            background-color: rgba(0, 0, 0, 0.8); 
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            padding: 30px;
            margin-bottom: 40px;
        }
        .chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .chat-item {
            display: flex;
            align-items: center;
            background-color: rgba(50, 50, 50, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .chat-img {
            border-radius: 50%; 
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 15px;
        }
        .chat-info {
            flex-grow: 1;
        }
        .chat-info h3 {
            margin: 0;
            font-size: 18px;
            color: #ff9900;
        }
        .chat-info p {
            font-size: 14px;
            color: greenyellow;
            margin: 5px 0;
        }
        .chat-status {
            font-size: 14px;
        }
        .chat-status.online {
            color: #00ff00;
        }
        .chat-status.offline {
            color: #ff0000;
        }
        .alert-message {
            color: #ff0000;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <ul id="chatList" class="chat-list">
                <!-- Chat items will be dynamically inserted here -->
            </ul>
        </div>
    </div>
    <ul class="navigation">
        <li>
          <a href="../../../index.html">
            <span class="icon">
              <ion-icon name="home-outline"></ion-icon>
            </span>
          </a>
        </li>
        <li>
          <a href="../../html/pages/profile.html">
            <span class="icon">
              <ion-icon name="person-outline"></ion-icon>
            </span>
          </a>
        </li>
        <li class="active">
          <a href="../../html/pages/chats.html">
            <span class="icon">
              <ion-icon name="chatbubble-outline"></ion-icon>
            </span>
          </a>
        </li>
    </ul>

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script src="../../js/nav/nav.js"></script>

    <script>
        // Function to calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Function to fetch player data and update the UI
        async function fetchAndDisplayPlayers() {
            try {
                const response = await fetch('https://serverdimm.onrender.com/getall');
                const players = await response.json();
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = ''; // Clear existing list

                // Assume these are the coordinates of the current user
                const currentLat = 44.4268; // Example latitude for Bucharest
                const currentLng = 26.1025; // Example longitude for Bucharest

                players.forEach(player => {
                    const distance = calculateDistance(currentLat, currentLng, player.latitudine, player.longitudine);
                    
                    const listItem = document.createElement('li');
                    listItem.className = 'chat-item';
                    listItem.innerHTML = `
                        <img src="../../../Utils/avatars/default.png" alt="${player.nume}" class="chat-img">
                        <div class="chat-info">
                            <h3>${player.nume}</h3>
                            <p>Team: ${player.team}</p>
                            <p>Distance: ${distance.toFixed(2)} km</p>
                            ${player.mesajalerta ? `<p class="alert-message">${player.mesajalerta}</p>` : ''}
                        </div>
                        <span class="chat-status">Ultima ora când a fost văzut</span>
                    `;
                    chatList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching player data:', error);
            }
        }

        // Call the function when the page loads
        window.addEventListener('load', fetchAndDisplayPlayers);

        // Refresh the list every 60 seconds
        setInterval(fetchAndDisplayPlayers, 60000);
    </script>
</body>
</html>