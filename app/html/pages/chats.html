<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/nav/nav.css">
    <link rel="stylesheet" href="../../css/chat.css">
    <title>Chat log | DIMM-SOFT</title>
    <style>
        /* Additional styling for "Near you" text */
        .near-you {
            color: blueviolet;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id = "Title">Chat Log</h1>
        <ul id="chatList" class="chat-list"></ul>
    </div>
    <ul class="navigation">
        <li>
          <a href="../../home.html">
            <span class="icon">
              <ion-icon name="home-outline"></ion-icon>
            </span>
          </a>
        </li>
        <li>
          <a href="../../html/pages/profile.html">
            <span class="icon">
              <ion-icon name="person-outline"></ion-icon>
            </span>
          </a>
        </li>
        <li class="active">
          <a href="../../html/pages/chats.html">
            <span class="icon">
              <ion-icon name="chatbubble-outline"></ion-icon>
            </span>
          </a>
        </li>
    </ul>

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script src="../../js/nav/nav.js"></script>

    <script>
        // Function to calculate distance between two points (in km)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Fetch the current user's data including lat/long from the database
        async function getCurrentUser() {
            const userId = localStorage.getItem('echipaId');  // Retrieve the user ID from localStorage
            if (!userId) {
                alert('No user ID found.');
                return null;
            }
            try {
                const response = await fetch(`https://serverdimm.onrender.com/get/${userId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch user data.');
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching current user data:', error);
                return null;
            }
        }

        // Function to format date to show only hours, minutes, and seconds
        function formatTime(dateString) {
            const date = new Date(dateString);
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const seconds = String(date.getUTCSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        // Function to fetch player data and update the UI
        async function fetchAndDisplayPlayers() {
            const currentUser = await getCurrentUser(); // Fetch current user details

            if (!currentUser) {
                return; // Stop if current user data couldn't be fetched
            }

            const currentLat = currentUser.latitudine; // Use the latitude from the current user's data
            const currentLng = currentUser.longitudine; // Use the longitude from the current user's data

            try {
                const response = await fetch('https://serverdimm.onrender.com/getall');
                const players = await response.json();
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = ''; // Clear existing list

                players.forEach(player => {
                    if (player.latitudine && player.longitudine) {
                        const distance = calculateDistance(currentLat, currentLng, player.latitudine, player.longitudine);

                        const listItem = document.createElement('li');
                        listItem.className = 'chat-item';

                        const formattedTime = formatTime(player.datataUltimuluiUpdate); // Format the time

                        // Create the distance message or "Near you" span
                        let distanceMessage;
                        if (distance === 0) {
                            distanceMessage = `<span class="near-you">Near you</span>`; // Display "Near you" in red
                        } else {
                            distanceMessage = `Distance: ${distance.toFixed(2)} km`;
                        }

                        listItem.innerHTML = `
                        <div class="chat-box">
                            <div class="chat-info">
                                <h3>${player.nume}</h3>
                                <p>Team: ${player.team}</p>
                                <p>${distanceMessage}</p>
                            </div>
                            <span class="chat-status">Last location update: ${formattedTime}</span>
                            <span class="message">${player.mesajalerta}</span>
                        </div>
                        `;
                        chatList.appendChild(listItem);
                    }
                });
            } catch (error) {
                console.error('Error fetching player data:', error);
            }
        }

        // Call the function when the page loads
        window.addEventListener('load', fetchAndDisplayPlayers);

        // Refresh the list every 60 seconds
        setInterval(fetchAndDisplayPlayers, 60000);
    </script>
</body>
</html>
